{% extends "base.html" %}
{% block title %}{{ service.name }} - My Site{% endblock %}
{% block content %}
    <style>
        .build-popover {
            z-index: 1050;
            min-width: 300px;
        }
    </style>
    <!-- htmlhint inline-style-disabled:false -->
    <div class="row mb-4">
        <div class="col">
            <a href="{% url 'list_services' %}"
               class="btn btn-outline-secondary mb-3">‚Üê Back to Services</a>
            <h1>{{ service.name }}</h1>
            <p class="text-muted">
                <span class="badge bg-info">{{ service.status }}</span>
            </p>
        </div>
    </div>
    <div class="row"
         x-data="{ attachGitSourceVisible: false, buildPopoverVisible: false }">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Service ID</p>
                            <p class="h6">{{ service.id }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Status</p>
                            <p class="h6">
                                <span class="badge bg-info">{{ service.status }}</span>
                            </p>
                        </div>
                    </div>
                    {% with template=service.proxy_template.first %}
                        {% if template %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p class="text-muted mb-1">Template</p>
                                    <p class="h6">
                                        <a href="{% url 'detail_template' template.id %}">{{ template.name }}</a>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="text-muted mb-1">Image</p>
                                    <p class="h6">
                                        <code>{{ service.image }}</code>
                                    </p>
                                </div>
                            </div>
                            {% if template.docs_url %}
                                <div class="mb-3">
                                    <p class="text-muted mb-1">Template Documentation</p>
                                    <p>
                                        <a href="{{ template.docs_url }}"
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           class="btn btn-sm btn-outline-primary">üìñ View Documentation</a>
                                    </p>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                    {% if service.domain %}
                        <div class="mb-3">
                            <p class="text-muted mb-1">Domain</p>
                            <p class="h6">{{ service.domain }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Environment Variables -->
            {% if service.env %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Environment Variables</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for var in service.env %}
                                    <tr>
                                        <td>
                                            <code>{{ var.key }}</code>
                                        </td>
                                        <td>
                                            <code class="text-break">{{ var.value }}</code>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            <!-- Exposed Ports -->
            {% if service.exposed_ports %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Exposed Ports</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Host Port</th>
                                    <th>Container Port</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for port in service.exposed_ports %}
                                    <tr>
                                        <td>
                                            {% if port.host_port %}
                                                {{ port.host_port }}
                                            {% else %}
                                                <span class="text-muted">Dynamic</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ port.container_port }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            <!-- Volumes -->
            {% if service.volumes %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Volumes</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Host Path</th>
                                    <th>Container Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for volume in service.volumes %}
                                    <tr>
                                        <td>
                                            {% if volume.host_path %}
                                                <code>{{ volume.host_path }}</code>
                                            {% else %}
                                                <span class="text-muted">Anonymous</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <code>{{ volume.container_path }}</code>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            <!-- Command & Args -->
            {% if service.command or service.args %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Execution</h5>
                    </div>
                    <div class="card-body">
                        {% if service.command %}
                            <p class="mb-2">
                                <strong>Command:</strong>
                                <br>
                                <code class="bg-body-secondary p-2 rounded d-block">{{ service.command }}</code>
                            </p>
                        {% endif %}
                        {% if service.args %}
                            <p>
                                <strong>Arguments:</strong>
                                <br>
                                <code class="bg-body-secondary p-2 rounded d-block">{{ service.args|join:" " }}</code>
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            <!-- Git Sources -->
            {% with git_sources=service.proxy_git_sources.all %}
                {% if git_sources %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Git Sources</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Repository</th>
                                        <th>Branch</th>
                                        <th>Destination</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for git_source in git_sources %}
                                        <tr>
                                            <td>
                                                <code class="text-break">{{ git_source.repository_url }}</code>
                                            </td>
                                            <td>
                                                <code>{{ git_source.branch }}</code>
                                            </td>
                                            <td>
                                                <code class="text-break">{{ git_source.destination_path }}</code>
                                            </td>
                                            <td>
                                                {% if git_source.is_updated %}
                                                    <span class="badge bg-success">Up to Date</span>
                                                {% elif git_source.is_cloned %}
                                                    <span class="badge bg-info">Outdated</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Not Downloaded</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm gap-2" role="group">
                                                    <form action="{% url 'download_git_source' service.id git_source.id %}"
                                                          method="post"
                                                          class="d-inline">
                                                        {% csrf_token %}
                                                        <button type="submit"
                                                                class="btn btn-primary"
                                                                title="Download/Update Git Source">
                                                            {% if git_source.downloaded_at %}
                                                                Update
                                                            {% else %}
                                                                Download
                                                            {% endif %}
                                                        </button>
                                                    </form>
                                                    <form action="{% url 'delete_git_source' service.id git_source.id %}"
                                                          method="post"
                                                          class="d-inline"
                                                          onsubmit="return confirm('Are you sure you want to delete this git source?');">
                                                        {% csrf_token %}
                                                        <button type="submit"
                                                                class="btn btn-outline-danger"
                                                                title="Delete Git Source">Delete</button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer">
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    @click="attachGitSourceVisible = true; setTimeout(() => { const el = document.getElementById('attach-git-source-form'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100)"
                                    x-show="!attachGitSourceVisible"
                                    style="display: none">Attach Another Git Source</button>
                            <button type="button"
                                    class="btn btn-sm btn-secondary"
                                    @click="attachGitSourceVisible = false"
                                    x-show="attachGitSourceVisible">Hide Form</button>
                        </div>
                    </div>
                    <!-- Attach Git Source Form -->
                    <div class="card mb-4"
                         id="attach-git-source-form"
                         x-show="attachGitSourceVisible"
                         x-transition>
                        <div class="card-header">
                            <h5 class="mb-0">Attach New Git Source</h5>
                        </div>
                        <form action="{% url 'attach_git_source' service.id %}"
                              method="post"
                              class="card-body">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="git_source_url" class="form-label">Repository URL</label>
                                <input type="url"
                                       class="form-control"
                                       id="git_source_url"
                                       name="git_source_url"
                                       placeholder="https://github.com/user/repo.git"
                                       required>
                                <small class="form-text text-muted">Full URL to the Git repository</small>
                            </div>
                            <div class="mb-3">
                                <label for="git_source_branch" class="form-label">Branch</label>
                                <input type="text"
                                       class="form-control"
                                       id="git_source_branch"
                                       name="git_source_branch"
                                       placeholder="main"
                                       value="main">
                                <small class="form-text text-muted">Git branch to checkout (default: main)</small>
                            </div>
                            {% with volumes_with_host=service.volumes|dictsort:"host_path" %}
                                {% if volumes_with_host|length == 1 %}
                                    {% with volume=volumes_with_host.0 %}
                                        <div class="mb-3">
                                            <label class="form-label">Base Path</label>
                                            <div class="form-control-plaintext p-2 border rounded bg-body-secondary">{{ volume.host_path }}</div>
                                            <small class="form-text text-muted d-block mt-1">Volume mounted at {{ volume.container_path }}</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="git_source_subdir" class="form-label">Subdirectory (Optional)</label>
                                            <input type="text"
                                                   class="form-control"
                                                   id="git_source_subdir"
                                                   placeholder="e.g., myapp"
                                                   @input="const base = '{{ volume.host_path }}'; const subdir = $el.value.trim(); document.getElementById('git_source_path').value = subdir ? base + '/' + subdir : base;">
                                            <small class="form-text text-muted">Optional subdirectory within the volume where the repository will be cloned</small>
                                        </div>
                                        <input type="hidden"
                                               id="git_source_path"
                                               name="git_source_path"
                                               value="{{ volume.host_path }}">
                                    {% endwith %}
                                {% else %}
                                    <div class="mb-3">
                                        <label for="git_source_path" class="form-label">Destination Path</label>
                                        <input type="text"
                                               class="form-control"
                                               id="git_source_path"
                                               name="git_source_path"
                                               placeholder="/absolute/path"
                                               required>
                                        <small class="form-text text-muted">Absolute path on the host filesystem where the repository will be cloned</small>
                                    </div>
                                {% endif %}
                            {% endwith %}
                            <div class="d-grid gap-2 d-sm-flex">
                                <button type="submit" class="btn btn-primary">Attach Git Source</button>
                                <button type="button"
                                        class="btn btn-secondary"
                                        @click="attachGitSourceVisible = false">Cancel</button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Git Sources</h5>
                        </div>
                        <div class="card-body text-muted">
                            <p class="mb-0">No git sources attached to this service.</p>
                        </div>
                        <div class="card-footer">
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    @click="attachGitSourceVisible = true; setTimeout(() => { const el = document.getElementById('attach-git-source-form-empty'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100)"
                                    x-show="!attachGitSourceVisible"
                                    style="display: none">Attach a Git Source</button>
                            <button type="button"
                                    class="btn btn-sm btn-secondary"
                                    @click="attachGitSourceVisible = false"
                                    x-show="attachGitSourceVisible">Hide Form</button>
                        </div>
                    </div>
                    <!-- Attach Git Source Form -->
                    <div class="card mb-4"
                         id="attach-git-source-form-empty"
                         x-show="attachGitSourceVisible"
                         x-transition>
                        <div class="card-header">
                            <h5 class="mb-0">Attach Git Source</h5>
                        </div>
                        <form action="{% url 'attach_git_source' service.id %}"
                              method="post"
                              class="card-body">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="git_source_url_empty" class="form-label">Repository URL</label>
                                <input type="url"
                                       class="form-control"
                                       id="git_source_url_empty"
                                       name="git_source_url"
                                       placeholder="https://github.com/user/repo.git"
                                       required>
                                <small class="form-text text-muted">Full URL to the Git repository</small>
                            </div>
                            <div class="mb-3">
                                <label for="git_source_branch_empty" class="form-label">Branch</label>
                                <input type="text"
                                       class="form-control"
                                       id="git_source_branch_empty"
                                       name="git_source_branch"
                                       placeholder="main"
                                       value="main">
                                <small class="form-text text-muted">Git branch to checkout (default: main)</small>
                            </div>
                            {% with volumes_with_host=service.volumes|dictsort:"host_path" %}
                                {% if volumes_with_host|length == 1 %}
                                    {% with volume=volumes_with_host.0 %}
                                        <div class="mb-3">
                                            <label class="form-label">Base Path</label>
                                            <div class="form-control-plaintext p-2 border rounded bg-body-secondary">{{ volume.host_path }}</div>
                                            <small class="form-text text-muted d-block mt-1">Volume mounted at {{ volume.container_path }}</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="git_source_subdir_empty" class="form-label">Subdirectory (Optional)</label>
                                            <input type="text"
                                                   class="form-control"
                                                   id="git_source_subdir_empty"
                                                   placeholder="e.g., myapp"
                                                   @input="const base = '{{ volume.host_path }}'; const subdir = $el.value.trim(); document.getElementById('git_source_path_empty').value = subdir ? base + '/' + subdir : base;">
                                            <small class="form-text text-muted">Optional subdirectory within the volume where the repository will be cloned.</small>
                                        </div>
                                        <input type="hidden"
                                               id="git_source_path_empty"
                                               name="git_source_path"
                                               value="{{ volume.host_path }}">
                                    {% endwith %}
                                {% else %}
                                    <div class="mb-3">
                                        <label for="git_source_path_empty" class="form-label">Destination Path</label>
                                        <input type="text"
                                               class="form-control"
                                               id="git_source_path_empty"
                                               name="git_source_path"
                                               placeholder="/absolute/path"
                                               required>
                                        <small class="form-text text-muted">Absolute path on the host filesystem where the repository will be cloned</small>
                                    </div>
                                {% endif %}
                            {% endwith %}
                            <div class="d-grid gap-2 d-sm-flex">
                                <button type="submit" class="btn btn-primary">Attach Git Source</button>
                                <button type="button"
                                        class="btn btn-secondary"
                                        @click="attachGitSourceVisible = false">Cancel</button>
                            </div>
                        </form>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top sticky-sidebar">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body d-grid gap-2">
                    <form action="{% url 'start_service' service.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-success w-100"
                                {% if service.status.value == 'running' or not service.container_id %}disabled{% endif %}>
                            Start Service
                        </button>
                    </form>
                    {% with template=service.proxy_template.first %}
                        {% if template and template.type == 'build' %}
                            <div class="position-relative">
                                <button type="button"
                                        class="btn btn-info w-100"
                                        @click="buildPopoverVisible = !buildPopoverVisible"
                                        title="Build the service image from Dockerfile">Build Service</button>
                                <!-- djlint:off H201-->
                                <div class="card position-absolute top-100 start-0 mt-2 p-3 build-popover"
                                     x-show="buildPopoverVisible"
                                     x-transition
                                     @click.away="buildPopoverVisible = false"
                                     role="dialog"
                                     aria-label="Build Service Dialog">
                                    <!-- djlint:on -->
                                    <div class="mb-3">
                                        <label for="build_path" class="form-label small">Build Context Path</label>
                                        {% if service.volumes %}
                                            <select class="form-select form-select-sm mb-2"
                                                    id="build_volume"
                                                    @change="document.getElementById('build_path').value = $el.value ? $el.value : ''">
                                                <option value="">-- Choose a volume or enter custom path --</option>
                                                {% for volume in service.volumes %}
                                                    {% if volume.host_path %}<option value="{{ volume.host_path }}">{{ volume.host_path }}</option>{% endif %}
                                                {% endfor %}
                                            </select>
                                        {% endif %}
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               id="build_path"
                                               placeholder="/absolute/path"
                                               required>
                                        <small class="form-text text-muted d-block mt-1">Absolute path on host filesystem</small>
                                    </div>
                                    <form action="{% url 'build_service' service.id %}"
                                          method="post"
                                          class="d-grid gap-2">
                                        {% csrf_token %}
                                        <input type="hidden" id="build_path_input" name="build_path" value="">
                                        <button type="submit"
                                                class="btn btn-sm btn-info"
                                                @click="document.getElementById('build_path_input').value = document.getElementById('build_path').value; if (!document.getElementById('build_path').value) { event.preventDefault(); alert('Please enter a build path'); }">
                                            Build
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-secondary"
                                                @click="buildPopoverVisible = false">Cancel</button>
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                    {% endwith %}
                    <form action="{% url 'stop_service' service.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-warning w-100"
                                {% if service.status.value != 'running' %}disabled{% endif %}>Stop Service</button>
                    </form>
                    <form action="{% url 'restart_service' service.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-primary w-100"
                                {% if service.status.value != 'running' %}disabled{% endif %}>Restart Service</button>
                    </form>
                    <a href="{% url 'view_service_logs' service.id %}"
                       class="btn btn-info w-100">View Logs</a>
                    <form action="{% url 'delete_service' service.id %}"
                          method="post"
                          onsubmit="return confirm('Are you sure you want to delete the service {{ service.name }}? This action cannot be undone.');">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-outline-danger w-100"
                                {% if service.status.value == 'running' %}disabled title="Stop the service before deleting"{% endif %}>
                            Delete Service
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

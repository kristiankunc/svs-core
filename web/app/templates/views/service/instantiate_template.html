{% extends "base.html" %}
{% block content %}
    <div>
        <div class="mb-6">
            <h1>Create Service from Template: {{ template.name }}</h1>
            <p class="text-gray-600">Customize your service settings or use the defaults provided by the template.</p>
        </div>
        <c-card>
        <c-card.header>
        <c-card.title>Service Configuration</c-card.title>
        </c-card.header>
        <c-card.content>
        <form method="post" class="space-y-8" x-data="{ envVars:
            {% if template.default_env %}
                true
            {% else %}
                false
            {% endif %}
            , ports:
            {% if template.default_ports %}
                true
            {% else %}
                false
            {% endif %}
            , volumes:
            {% if template.default_volumes %}
                true
            {% else %}
                false
            {% endif %}
            }">
            {% csrf_token %}
            <div class="space-y-4">
                <h3 class="text-lg font-semibold">Basic Information</h3>
                <c-form.field>
                <c-form.label for="service_name">Service Name</c-form.label>
                <c-input id="service_name" name="service_name" type="text" placeholder="Enter a name for your service" required></c-input>
                <c-form.description>
                This will be used to identify your service.
                </c-form.description>
                </c-form.field>
                {% if template.start_cmd %}
                    <c-form.field>
                    <c-form.label for="start_cmd">Start Command</c-form.label>
                    <c-input id="start_cmd" name="start_cmd" type="text" value="{{ template.start_cmd }}" placeholder="Command to start the service"></c-input>
                    <c-form.description>
                    Default command from template: <code class="bg-gray-100 px-1 py-0.5 rounded text-sm">{{ template.start_cmd }}</code>
                    </c-form.description>
                    </c-form.field>
                {% endif %}
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Environment Variables</h3>
                    <c-button type="button" variant="outline" size="sm" @click=" if(!$data.newEnvVars) $data.newEnvVars = []; $data.newEnvVars.push({}); envVars = true; ">
                    <span class="mr-1">+</span> Add Variable
                    </c-button>
                </div>
                <div id="env-vars-container">
                    {% if template.default_env %}
                        {% for env in template.default_env %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 env-var-row">
                                <c-form.field>
                                <c-form.label for="env_key_{{ forloop.counter }}">Key</c-form.label>
                                <c-input id="env_key_{{ forloop.counter }}" name="env_key[]" type="text" value="{{ env.key }}" placeholder="Environment variable key"></c-input>
                                </c-form.field>
                                <c-form.field>
                                <c-form.label for="env_value_{{ forloop.counter }}">Value</c-form.label>
                                <c-input id="env_value_{{ forloop.counter }}" name="env_value[]" type="text" value="{{ env.value }}" placeholder="Environment variable value"></c-input>
                                </c-form.field>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 italic" x-show="!envVars">No default environment variables defined.</p>
                    {% endif %}
                    <template x-for="(item, index) in $data.newEnvVars || []" :key="index">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 env-var-row relative">
                            <c-form.field>
                            <c-form.label :for="'env_key_new_' + index">Key</c-form.label>
                            <c-input :id="'env_key_new_' + index" name="env_key[]" type="text" placeholder="Environment variable key"></c-input>
                            </c-form.field>
                            <c-form.field class="pr-8">
                            <c-form.label :for="'env_value_new_' + index">Value</c-form.label>
                            <c-input :id="'env_value_new_' + index" name="env_value[]" type="text" placeholder="Environment variable value"></c-input>
                            <button type="button"
                                    @click="$data.newEnvVars.splice(index, 1); if($data.newEnvVars.length === 0 && !document.querySelector('.env-var-row:not(.relative)')) envVars = false"
                                    class="absolute right-0 top-8 p-1 text-gray-500 hover:text-red-500 focus:outline-none"
                                    title="Remove">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                                </svg>
                            </button>
                            </c-form.field>
                        </div>
                    </template>
                </div>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold">Port Mappings</h3>
                        <p class="text-sm text-gray-500">Host ports are automatically managed by the system</p>
                    </div>
                    <c-button type="button" variant="outline" size="sm" @click=" if(!$data.newPorts) $data.newPorts = []; $data.newPorts.push({}); ports = true; ">
                    <span class="mr-1">+</span> Add Port
                    </c-button>
                </div>
                <div id="ports-container">
                    {% if template.default_ports %}
                        {% for port in template.default_ports %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 port-row">
                                <c-form.field>
                                <c-form.label for="container_port_{{ forloop.counter }}">Container Port</c-form.label>
                                <c-input id="container_port_{{ forloop.counter }}" name="container_port[]" type="number" value="{{ port.container_port }}" placeholder="Container port" disabled></c-input>
                                </c-form.field>
                                <c-form.field>
                                <c-form.label for="host_port_{{ forloop.counter }}">Host Port</c-form.label>
                                <c-input id="host_port_{{ forloop.counter }}" name="host_port[]" type="number" value="{{ port.host_port|default:'' }}" placeholder="Auto-assigned" disabled class="bg-gray-100"></c-input>
                                </c-form.field>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 italic" x-show="!ports">No default ports defined.</p>
                    {% endif %}
                    <template x-for="(item, index) in $data.newPorts || []" :key="index">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 port-row relative">
                            <c-form.field>
                            <c-form.label :for="'container_port_new_' + index">Container Port</c-form.label>
                            <c-input :id="'container_port_new_' + index" name="container_port[]" type="number" placeholder="Container port"></c-input>
                            </c-form.field>
                            <c-form.field class="pr-8">
                            <c-form.label :for="'host_port_new_' + index">Host Port</c-form.label>
                            <c-input :id="'host_port_new_' + index" name="host_port[]" type="number" placeholder="Auto-assigned" disabled class="bg-gray-100"></c-input>
                            <button type="button"
                                    @click="$data.newPorts.splice(index, 1); if($data.newPorts.length === 0 && !document.querySelector('.port-row:not(.relative)')) ports = false"
                                    class="absolute right-0 top-8 p-1 text-gray-500 hover:text-red-500 focus:outline-none"
                                    title="Remove">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                                </svg>
                            </button>
                            </c-form.field>
                        </div>
                    </template>
                </div>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold">Volume Mappings</h3>
                        <p class="text-sm text-gray-500">Host paths are automatically managed by the system</p>
                    </div>
                    <c-button type="button" variant="outline" size="sm" @click=" if(!$data.newVolumes) $data.newVolumes = []; $data.newVolumes.push({}); volumes = true; ">
                    <span class="mr-1">+</span> Add Volume
                    </c-button>
                </div>
                <div id="volumes-container">
                    {% if template.default_volumes %}
                        {% for volume in template.default_volumes %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 volume-row">
                                <c-form.field>
                                <c-form.label for="container_path_{{ forloop.counter }}">Container Path</c-form.label>
                                <c-input id="container_path_{{ forloop.counter }}" name="container_path[]" type="text" value="{{ volume.container_path }}" placeholder="Path inside container" disabled></c-input>
                                </c-form.field>
                                <c-form.field>
                                <c-form.label for="host_path_{{ forloop.counter }}">Host Path</c-form.label>
                                <c-input id="host_path_{{ forloop.counter }}" name="host_path[]" type="text" value="{{ volume.host_path|default:'' }}" placeholder="Auto-generated by server" disabled class="bg-gray-100"></c-input>
                                </c-form.field>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 italic" x-show="!volumes">No default volumes defined.</p>
                    {% endif %}
                    <template x-for="(item, index) in $data.newVolumes || []" :key="index">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 volume-row relative">
                            <c-form.field>
                            <c-form.label :for="'container_path_new_' + index">Container Path</c-form.label>
                            <c-input :id="'container_path_new_' + index" name="container_path[]" type="text" placeholder="Path inside container"></c-input>
                            </c-form.field>
                            <c-form.field class="pr-8">
                            <c-form.label :for="'host_path_new_' + index">Host Path</c-form.label>
                            <c-input :id="'host_path_new_' + index" name="host_path[]" type="text" placeholder="Auto-generated by server" disabled class="bg-gray-100"></c-input>
                            <button type="button"
                                    @click="$data.newVolumes.splice(index, 1); if($data.newVolumes.length === 0 && !document.querySelector('.volume-row:not(.relative)')) volumes = false"
                                    class="absolute right-0 top-8 p-1 text-gray-500 hover:text-red-500 focus:outline-none"
                                    title="Remove">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                                </svg>
                            </button>
                            </c-form.field>
                        </div>
                    </template>
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <a href="{% url 'template_detail' template.id %}">
                    <c-button variant="outline">Cancel</c-button>
                </a>
                <c-button type="submit">Create Service</c-button>
            </div>
        </form>
        </c-card.content>
        </c-card>
    </div>
{% endblock %}

{% extends "base.html" %}
{% block title %}Import Template - My Site{% endblock %}
{% block content %}
    <div class="row mb-4">
        <div class="col">
            <a href="{% url 'list_templates' %}"
               class="btn btn-outline-secondary mb-3">‚Üê Back to Templates</a>
            <h1>Import Template</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8" x-data="templateImportData()">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Fetch from Remote URL</h5>
                </div>
                <div class="card-body">
                    <form class="mb-3" @submit.prevent="fetchTemplate">
                        {% csrf_token %}
                        <div class="input-group mb-3">
                            <input type="url"
                                   class="form-control"
                                   x-model="remoteUrl"
                                   @keypress.enter="fetchTemplate"
                                   placeholder="https://example.com/template.json"
                                   required>
                            <button class="btn btn-outline-primary"
                                    type="button"
                                    @click="fetchTemplate"
                                    :disabled="isLoading">
                                <span x-show="!isLoading">Fetch</span>
                                <span x-show="isLoading">Fetching...</span>
                                <span x-show="isLoading"
                                      class="spinner-border spinner-border-sm ms-2"
                                      role="status"
                                      aria-hidden="true"></span>
                            </button>
                        </div>
                        <small class="text-muted">Enter the URL of a remote JSON template file to fetch and edit.</small>
                    </form>
                </div>
            </div>
            <form method="post" id="import-form">
                {% csrf_token %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Template JSON</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="json_data" class="form-label">JSON Content</label>
                            <div class="mb-3">
                                <pre id="json_display" class="bg-body-secondary p-2 rounded" style="max-height:400px; overflow:auto;">
                                    <code class="language-json" id="json_code"></code>
                                </pre>
                            </div>
                            <textarea id="json_data"
                                      class="form-control font-monospace"
                                      name="json_data"
                                      rows="15"
                                      required
                                      x-model="jsonContent"
                                      style="font-size: 0.875rem;
                                             display: none"></textarea>
                            <small class="text-muted d-block mt-2">
                                You can paste JSON directly or fetch it from a remote URL. Once the content is loaded, you can edit it before importing.
                            </small>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">Import Template</button>
                        <a href="{% url 'list_templates' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-lg-4">
            <div class="card bg-body-secondary">
                <div class="card-header">
                    <h5 class="mb-0">JSON Format Guide</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">A valid template JSON should contain:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>name</strong> - Template name
                        </li>
                        <li class="mb-2">
                            <strong>type</strong> - Template type
                        </li>
                        <li class="mb-2">
                            <strong>image</strong> - Docker image name
                        </li>
                        <li class="mb-2">
                            <strong>description</strong> - Template description (optional)
                        </li>
                        <li class="mb-2">
                            <strong>env_variables</strong> - List of environment variables
                        </li>
                        <li class="mb-2">
                            <strong>ports</strong> - List of exposed ports
                        </li>
                        <li class="mb-2">
                            <strong>volumes</strong> - List of volumes
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        function templateImportData() {
            return {
                remoteUrl: '',
                jsonContent: '',
                isLoading: false,
                updateHighlight() {
                    const codeEl = document.getElementById('json_code');
                    codeEl.textContent = this.jsonContent;
                    codeEl.dataset.highlighted = '';
                    if (window.hljs) {
                        window.hljs.highlightElement(codeEl);
                    }
                },
                async fetchTemplate() {
                    const url = this.remoteUrl.trim();

                    if (!url) {
                        alert('Please enter a valid URL');
                        return;
                    }

                    this.isLoading = true;

                    try {
                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const text = await response.text();

                        // Try to parse as JSON to validate
                        JSON.parse(text);

                        // Populate the textarea with formatted JSON
                        this.jsonContent = JSON.stringify(JSON.parse(text), null, 2);
                        this.updateHighlight();

                        // Scroll to the editor
                        setTimeout(() => {
                            document.getElementById('json_display').scrollIntoView({ behavior: 'smooth' });
                        }, 0);

                    } catch (error) {
                        let errorMsg = 'Failed to fetch template from URL.';
                        if (error instanceof SyntaxError) {
                            errorMsg = 'Invalid JSON content received from URL.';
                        } else if (error instanceof TypeError) {
                            errorMsg = 'Could not fetch from URL. Check CORS and URL validity.';
                        } else {
                            errorMsg = error.message;
                        }
                        alert(errorMsg);
                    } finally {
                        this.isLoading = false;
                    }
                }
            };
        }
    </script>
{% endblock %}

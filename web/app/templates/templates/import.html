{% extends "base.html" %}
{% block title %}Import Template - My Site{% endblock %}
{% block content %}
    <div class="row mb-4">
        <div class="col">
            <a href="{% url 'list_templates' %}"
               class="btn btn-outline-secondary mb-3">‚Üê Back to Templates</a>
            <h1>Import Template</h1>
        </div>
    </div>
    <div class="row" x-data="templateImporter()">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Fetch from Remote URL</h5>
                </div>
                <div class="card-body">
                    <form @submit.prevent="fetchTemplate" class="mb-3">
                        {% csrf_token %}
                        <div class="input-group mb-3">
                            <input type="url"
                                   class="form-control"
                                   x-model="remoteUrl"
                                   placeholder="https://example.com/template.json"
                                   required>
                            <button class="btn btn-outline-primary" type="submit" :disabled="isLoading">
                                <span x-show="!isLoading">Fetch</span>
                                <span x-show="isLoading"
                                      class="spinner-border spinner-border-sm"
                                      role="status"
                                      aria-hidden="true"></span>
                            </button>
                        </div>
                        <small class="text-muted">Enter the URL of a remote JSON template file to fetch and edit.</small>
                    </form>
                </div>
            </div>
            <form method="post" id="import-form">
                {% csrf_token %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Template JSON</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="json_data" class="form-label">JSON Content</label>
                            <textarea class="form-control font-monospace"
                                      id="json_data"
                                      name="json_data"
                                      x-model="jsonData"
                                      rows="15"
                                      placeholder='Paste your template JSON here or use the "Fetch" button above to load from a remote URL'
                                      required></textarea>
                            <small class="text-muted d-block mt-2">
                                You can paste JSON directly or fetch it from a remote URL. Once the content is loaded, you can edit it before importing.
                            </small>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">Import Template</button>
                        <a href="{% url 'list_templates' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h5 class="mb-0">JSON Format Guide</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">A valid template JSON should contain:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>name</strong> - Template name
                        </li>
                        <li class="mb-2">
                            <strong>type</strong> - Template type
                        </li>
                        <li class="mb-2">
                            <strong>image</strong> - Docker image name
                        </li>
                        <li class="mb-2">
                            <strong>description</strong> - Template description (optional)
                        </li>
                        <li class="mb-2">
                            <strong>env_variables</strong> - List of environment variables
                        </li>
                        <li class="mb-2">
                            <strong>ports</strong> - List of exposed ports
                        </li>
                        <li class="mb-2">
                            <strong>volumes</strong> - List of volumes
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        function templateImporter() {
            return {
                remoteUrl: '',
                jsonData: '',
                isLoading: false,

                async fetchTemplate() {
                    const url = this.remoteUrl.trim();

                    if (!url) {
                        alert('Please enter a valid URL');
                        return;
                    }

                    this.isLoading = true;

                    try {
                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const text = await response.text();

                        JSON.parse(text);

                        this.jsonData = JSON.stringify(JSON.parse(text), null, 2);

                        document.getElementById('json_data').scrollIntoView({ behavior: 'smooth' });
                        document.getElementById('json_data').focus();

                    } catch (error) {
                        let errorMsg = 'Failed to fetch template from URL.';
                        if (error instanceof SyntaxError) {
                            errorMsg = 'Invalid JSON content received from URL.';
                        } else if (error instanceof TypeError) {
                            errorMsg = 'Could not fetch from URL. Check CORS and URL validity.';
                        } else {
                            errorMsg = error.message;
                        }
                        alert(errorMsg);
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>
{% endblock %}

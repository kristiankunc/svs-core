name: Test with Sudo User

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: debian-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create sudo user
        run: |
          sudo useradd -m testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/testuser
          sudo chown -R testuser:testuser .

      - name: Set up Python for testuser
        run: |
          sudo -u testuser bash -c "
            python3 -m venv .venv &&
            source .venv/bin/activate &&
            pip install -r requirements.txt
          "

      - name: Run pytest as sudo user
        run: |
          sudo -u testuser bash -c "
            source .venv/bin/activate &&
            pytest
          "
